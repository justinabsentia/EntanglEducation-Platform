#!/bin/bash
set -e  # Exit on error

echo "ğŸš€ Starting EntangledU Setup & Fixes..."

# 1. Install Dependencies
echo "ğŸ“¦ Installing dependencies..."
npm install --save-dev husky lint-staged web-vitals @babel/parser @babel/traverse @babel/generator @babel/types glob
npx husky init

# 2. Configure package.json scripts
echo "âš™ï¸  Configuring package.json scripts..."
npm pkg set scripts.lint="eslint . --ext .js,.jsx --report-unused-disable-directives --max-warnings 0"
npm pkg set lint-staged."src/**/*.{js,jsx,ts,tsx}"[0]="eslint --fix"
npm pkg set lint-staged."src/**/*.{js,jsx,ts,tsx}"[1]="prettier --write"

# 3. Write: useLocalStorage.js (SSR-safe, cross-tab sync)
echo "ğŸ”§ Creating SSR-safe useLocalStorage hook..."
mkdir -p src/hooks
cat << 'EOF' > src/hooks/useLocalStorage.js
import { useState, useEffect, useRef } from 'react';

export const useLocalStorage = (key, initialValue) => {
  const [storedValue, setStoredValue] = useState(() => {
    try {
      if (typeof window === 'undefined') return initialValue;
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : initialValue;
    } catch (error) {
      console.warn(`Error reading localStorage key "${key}":`, error);
      return initialValue;
    }
  });

  const isStorageEvent = useRef(false);

  useEffect(() => {
    if (typeof window === 'undefined') return;
    if (isStorageEvent.current) {
      isStorageEvent.current = false;
      return;
    }
    try {
      window.localStorage.setItem(key, JSON.stringify(storedValue));
    } catch (error) {
      console.warn(`Error setting localStorage key "${key}":`, error);
    }
  }, [key, storedValue]);

  useEffect(() => {
    const onStorage = (e) => {
      if (e.key === key) {
        try {
          isStorageEvent.current = true; 
          setStoredValue(e.newValue ? JSON.parse(e.newValue) : null);
        } catch {
          setStoredValue(null);
        }
      }
    };
    window.addEventListener('storage', onStorage);
    return () => window.removeEventListener('storage', onStorage);
  }, [key]);

  const setValue = (value) => {
    try {
      const valueToStore = value instanceof Function ? value(storedValue) : value;
      setStoredValue(valueToStore);
    } catch (error) {
      console.warn(`Error setting state for key "${key}":`, error);
    }
  };

  return [storedValue, setValue];
};
EOF

# 4. Write: HolographicLessonEnhanced.jsx (Fixed interaction mesh)
echo "ğŸ¨ Creating HolographicLessonEnhanced component..."
mkdir -p src/components
cat << 'EOF' > src/components/HolographicLessonEnhanced.jsx
import React, { useState, useRef } from 'react';
import { useFrame } from '@react-three/fiber';

export const Sphere = ({ onPass, position, active, onSolve }) => {
  const [hover, setHover] = useState(false);
  const meshRef = useRef();

  useFrame((state, delta) => {
    if (meshRef.current) {
      meshRef.current.rotation.y += delta * 0.2;
      meshRef.current.rotation.x += delta * 0.1;
    }
  });

  return (
    <group position={position}>
      {/* Visible holographic sphere */}
      <mesh ref={meshRef}>
        <sphereGeometry args={[1, 64, 64]} />
        <meshStandardMaterial
          color={hover ? "#00ffaa" : active ? "#00ff88" : "#444"}
          wireframe
          transparent
          opacity={0.8}
        />
      </mesh>

      {/* Interaction mesh - transparent but receives pointer events */}
      <mesh
        scale={1.1}
        onPointerOver={() => setHover(true)}
        onPointerOut={() => setHover(false)}
        onClick={onSolve}
      >
        <sphereGeometry args={[1, 64, 64]} />
        <meshBasicMaterial
          transparent
          opacity={0}
          depthWrite={false}
        />
      </mesh>
    </group>
  );
};

export default Sphere;
EOF

# 5. Fix Tailwind Config (if exists)
echo "ğŸ¨ Checking Tailwind config..."
if [ -f "tailwind.config.js" ]; then
  echo "Found tailwind.config.js - converting to CommonJS..."
  sed -i.bak 's/^export default/module.exports =/g' tailwind.config.js
  rm -f tailwind.config.js.bak
else
  echo "âš ï¸  No tailwind.config.js found - skipping"
fi

# 6. Write: CI Workflow
echo "ğŸ”„ Setting up GitHub Actions CI..."
mkdir -p .github/workflows
cat << 'EOF' > .github/workflows/ci.yml
name: Node.js CI
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with: 
        node-version: 20.x
        cache: 'npm'
    - run: npm ci
    - run: npm run lint
  
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with: 
        node-version: 20.x
        cache: 'npm'
    - run: npm ci
    - run: npm test
      env:
        CI: true
EOF

# 7. Write: Git Hooks
echo "ğŸª Setting up Husky pre-commit hooks..."
cat << 'EOF' > .husky/pre-commit
#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

npx lint-staged
npm test -- --watchAll=false --onlyChanged
EOF
chmod +x .husky/pre-commit

# 8. Git status check
echo ""
echo "ğŸ“‹ Changes made:"
git status --short

# 9. Commit and Push
echo ""
read -p "ğŸ¤” Ready to commit and push? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]
then
    echo "ğŸ“ Committing changes..."
    git add .
    git commit -m "refactor: apply holographic stability update (v1.1.0)

- Add SSR-safe useLocalStorage with cross-tab sync
- Fix HolographicLessonEnhanced interaction mesh
- Convert Tailwind config to CommonJS
- Add CI/CD workflows and pre-commit hooks"
    
    echo "ğŸš€ Pushing to GitHub..."
    git push
    
    echo "âœ… Done! Changes pushed successfully!"
else
    echo "â¸ï¸  Stopped. Changes are staged but not committed."
    echo "   Run 'git status' to see what changed."
fi
EOF